{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block page_header %}
<div class="container header-container">
    <div class="row">
        <div class="col"></div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="overlay"></div>
<div class="container">
    <div class="row">
        <div class="col">
            <hr>
            <h2 class="logo-font mb-4">Checkout</h2>
            <hr>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-lg-6 order-lg-last mb-5">
            <p class="text-muted">Order Summary ({{ cart.total_items }} items)</p>
            <div class="row">
                <div class="col-7 offset-2">
                    <p class="mb-1 mt-0 small text-muted">Item</p>
                </div>
                <div class="col-3 text-right">
                    <p class="mb-1 mt-0 small text-muted">Subtotal</p>
                </div>
            </div>
            {% for item in cart_items %}
                <div class="row">
                    <div class="col-2 mb-1">
                        <a href="{% url 'product_detail' item.product.id %}">
                            {% if item.product.image %}
                                <img class="w-100" src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                            {% elif item.product.image_url %}
                                <img class="w-100" src="{{ item.product.image_url }}" alt="{{ item.product.name }}">
                            {% else %}
                                <div class="w-100 bg-light d-flex align-items-center justify-content-center" style="min-height: 80px;">
                                    <i class="fa fa-image fa-2x text-muted"></i>
                                </div>
                            {% endif %}
                        </a>
                    </div>
                    <div class="col-7">
                        <p class="my-0"><strong>{{ item.product.name }}</strong></p>
                        {% if item.size %}
                            <p class="my-0 small">Size: {{ item.size.display_name }}</p>
                        {% endif %}
                        <p class="my-0 small text-muted">Qty: {{ item.quantity }}</p>
                    </div>
                    <div class="col-3 text-right">
                        <p class="my-0 small text-muted">€{{ item.line_total }}</p>
                    </div>
                </div>
            {% endfor %}
            <hr class="my-0">
            <div class="row text-black text-right">
                <div class="col-7 offset-2">
                    <p class="my-0">Order Total:</p>
                    <p class="my-0">Delivery:</p>
                    <p class="my-0"><strong>Grand Total:</strong></p>
                </div>
                <div class="col-3">
                    <p class="my-0">€{{ cart.subtotal }}</p>
                    <p class="my-0">€{{ cart.delivery_cost }}</p>
                    <p class="my-0"><strong>€{{ cart.total }}</strong></p>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <p class="text-muted">Please fill out the form below to complete your order</p>
            <form action="{% url 'orders:checkout' %}" method="POST" id="payment-form">
                {% csrf_token %}
                <fieldset class="rounded px-3 mb-5">
                    <legend class="fieldset-label small text-black px-2 w-auto">Details</legend>
                    {{ form.full_name | as_crispy_field }}
                    {{ form.email | as_crispy_field }}
                </fieldset>
                <fieldset class="rounded px-3 mb-5">
                    <legend class="fieldset-label small text-black px-2 w-auto">Delivery</legend>
                    {{ form.phone_number | as_crispy_field }}
                    {{ form.street_address1 | as_crispy_field }}
                    {{ form.street_address2 | as_crispy_field }}
                    {{ form.town_or_city | as_crispy_field }}
                    {{ form.county | as_crispy_field }}
                    {{ form.postcode | as_crispy_field }}
                    {{ form.country | as_crispy_field }}
                    <div class="form-check form-check-inline float-right mr-0">
                        {% if user.is_authenticated %}
                            <label class="form-check-label" for="id-save-info">Save this delivery information to my profile</label>
                            <input class="form-check-input ml-2 mr-0" type="checkbox" id="id-save-info" name="save-info" checked>
                        {% else %}
                            <label class="form-check-label" for="id-save-info">
                                <a class="text-info" href="{% url 'account_signup' %}">Create an account</a> or 
                                <a class="text-info" href="{% url 'account_login' %}">login</a> to save this information
                            </label>
                        {% endif %}
                    </div>
                </fieldset>
                
                <!-- Order Summary for Mobile -->
                <div class="d-block d-lg-none">
                    <hr>
                    <h5>Order Summary</h5>
                    <div class="row">
                        <div class="col-6">
                            <p>Order Total:</p>
                            <p>Delivery:</p>
                            <p><strong>Grand Total:</strong></p>
                        </div>
                        <div class="col-6 text-right">
                            <p>€{{ cart.subtotal }}</p>
                            <p>€{{ cart.delivery_cost }}</p>
                            <p><strong>€{{ cart.total }}</strong></p>
                        </div>
                    </div>
                    <hr>
                </div>
                
                <!-- Stripe Payment Element -->
                <fieldset class="rounded px-3 mb-5">
                    <legend class="fieldset-label small text-black px-2 w-auto">Payment Information</legend>
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fa fa-lock"></i> Your payment information is secure and encrypted
                        </small>
                    </div>
                    <div class="mb-3" id="card-element-container" style="min-height: 40px; padding: 10px; border: 1px solid #000; border-radius: 4px; background-color: white;">
                        <div id="card-element-loading" style="color: #aab7c4; font-style: italic;">Loading payment form...</div>
                        <div id="card-element" style="display: none;"></div>
                    </div>
                    
                    <!-- Pass the client secret to the view so we can get the payment intent id -->
                    <input type="hidden" value="{{ client_secret }}" name="client_secret">
                    
                    <!-- Used to display form errors -->
                    <div id="card-errors" class="text-danger mt-2" role="alert" style="display: none;"></div>
                    <div id="card-success" class="text-success mt-2" role="alert" style="display: none;">
                        <i class="fa fa-check-circle"></i> Payment method ready
                    </div>
                    
                    <!-- Test card information for development -->
                    {% if debug %}
                    <div class="mt-3 p-2 bg-light border rounded">
                        <small class="text-muted">
                            <strong>Test Mode:</strong> Use card number 4242 4242 4242 4242 with any future date and CVC<br>
                            <em>Note: HTTPS warnings in development are normal and will be resolved in production.</em>
                        </small>
                    </div>
                    {% endif %}
                </fieldset>
                
                <div class="submit-button text-right mt-5 mb-2">                    
                    <a href="{% url 'shopping_cart:cart' %}" class="btn btn-outline-black rounded-0">
                        <span class="icon">
                            <i class="fa fa-chevron-left"></i>
                        </span>
                        <span class="font-weight-bold">Adjust Cart</span>
                    </a>
                    <button id="submit-button" class="btn btn-black rounded-0">
                        <span class="font-weight-bold">Complete Order</span>
                        <span class="icon">
                            <i class="fa fa-lock"></i>
                        </span>
                    </button>
                    <p class="small text-danger my-0">
                        <span class="icon">
                            <i class="fa fa-exclamation-circle"></i>
                        </span>
                        <span>Your card will be charged <strong>€{{ cart.total }}</strong></span>
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
            <span class="sr-only">Processing...</span>
        </div>
        <div class="spinner-text" style="text-align: center !important;">
            <div id="loading-message" style="text-align: center !important; width: 100%;">Processing your secure payment...</div>
            <small class="mt-2 d-block" style="text-align: center !important; width: 100%;">Please do not refresh or close this page</small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    {{ stripe_public_key|json_script:"id_stripe_public_key" }}
    {{ client_secret|json_script:"id_client_secret" }}
    
    <!-- Load Stripe library -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Stripe checkout script -->
    <script>
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCheckout);
        } else {
            initCheckout();
        }
        
        function initCheckout() {
            const publicKey = '{{ stripe_public_key }}';
            const clientSecret = '{{ client_secret }}';
            
            if (!publicKey || !clientSecret) {
                console.error('Missing Stripe configuration');
                return;
            }
            
            // Initialize Stripe when available
            let attempts = 0;
            function waitForStripe() {
                attempts++;
                
                if (typeof Stripe !== 'undefined') {
                    setupStripeElements();
                } else if (attempts < 50) {
                    setTimeout(waitForStripe, 100);
                } else {
                    console.error('Stripe library failed to load');
                    const errorElement = document.getElementById('card-errors');
                    if (errorElement) {
                        errorElement.textContent = 'Payment system failed to load. Please refresh the page or contact support.';
                        errorElement.style.display = 'block';
                    }
                    const loadingElement = document.getElementById('card-element-loading');
                    if (loadingElement) {
                        loadingElement.textContent = 'Error: Payment system failed to load';
                        loadingElement.style.color = '#dc3545';
                    }
                }
            }
            
            function setupStripeElements() {
                try {
                    const stripe = Stripe(publicKey);
                    const elements = stripe.elements();
                    
                    // Hide loading text and show card element container
                    const loadingElement = document.getElementById('card-element-loading');
                    const cardElementDiv = document.getElementById('card-element');
                    
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    if (cardElementDiv) {
                        cardElementDiv.style.display = 'block';
                    }
                    
                    const cardElement = elements.create('card', {
                        hidePostalCode: true,
                        style: {
                            base: {
                                fontSize: '16px',
                                color: '#000',
                                '::placeholder': { color: '#aab7c4' }
                            }
                        }
                    });
                    
                    // Mount the card element to the empty div
                    cardElement.mount('#card-element');
                    
                    // Handle card changes
                    cardElement.on('change', function(event) {
                        const errorElement = document.getElementById('card-errors');
                        const successElement = document.getElementById('card-success');
                        
                        if (event.error) {
                            if (errorElement) {
                                errorElement.textContent = event.error.message;
                                errorElement.style.display = 'block';
                            }
                            if (successElement) {
                                successElement.style.display = 'none';
                            }
                        } else {
                            if (errorElement) {
                                errorElement.textContent = '';
                                errorElement.style.display = 'none';
                            }
                            if (event.complete && successElement) {
                                successElement.style.display = 'block';
                            }
                        }
                    });
                    
                    // Handle element ready event
                    cardElement.on('ready', function() {
                        // Stripe Elements is ready
                    });
                    
                    // Handle form submission
                    const form = document.getElementById('payment-form');
                    if (form) {
                        form.addEventListener('submit', function(event) {
                            event.preventDefault();
                            
                            const submitButton = document.getElementById('submit-button');
                            if (submitButton) {
                                submitButton.disabled = true;
                                submitButton.textContent = 'Processing...';
                            }
                            
                            stripe.confirmCardPayment(clientSecret, {
                                payment_method: {
                                    card: cardElement,
                                    billing_details: {
                                        name: form.full_name ? form.full_name.value : '',
                                        email: form.email ? form.email.value : ''
                                    }
                                }
                            }).then(function(result) {
                                if (result.error) {
                                    const errorElement = document.getElementById('card-errors');
                                    if (errorElement) {
                                        errorElement.textContent = result.error.message;
                                        errorElement.style.display = 'block';
                                    }
                                    if (submitButton) {
                                        submitButton.disabled = false;
                                        submitButton.textContent = 'Complete Order';
                                    }
                                } else {
                                    // Payment succeeded - show loading overlay
                                    const loadingOverlay = document.getElementById('loading-overlay');
                                    if (loadingOverlay) {
                                        loadingOverlay.style.display = 'flex';
                                    }
                                    
                                    // Submit the form
                                    form.submit();
                                }
                            }).catch(function(error) {
                                console.error('Payment confirmation error:', error);
                                const errorElement = document.getElementById('card-errors');
                                if (errorElement) {
                                    errorElement.textContent = 'Payment processing error: ' + error.message;
                                    errorElement.style.display = 'block';
                                }
                                if (submitButton) {
                                    submitButton.disabled = false;
                                    submitButton.textContent = 'Complete Order';
                                }
                            });
                        });
                    }
                    
                } catch (error) {
                    console.error('Stripe setup error:', error);
                }
            }
            
            // Start waiting for Stripe
            waitForStripe();
        }
    </script>

<style>
    .fieldset-label {
        position: relative;
        right: .5rem;
    }

    #payment-form .form-control,
    #card-element-container {
        color: #000;
        border: 1px solid #ccc;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    #card-element {
        padding: 0;
        border: none;
        background: transparent;
    }

    #payment-form .form-control:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #payment-form .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .stripe-style-input {
        box-sizing: border-box;
        height: 40px;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: white;
        box-shadow: 0 1px 3px 0 #e6ebf1;
        -webkit-transition: all 150ms ease;
        transition: all 150ms ease;
    }

    .stripe-style-input:focus,
    .stripe-style-input:hover {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .stripe-style-input::placeholder {
        color: #87bbfd;
    }

    /* Fix placeholder colors to match the muted text */
    .form-control::placeholder {
        color: #6c757d !important; /* Same color as "Please fill out the form below" text */
        opacity: 1;
    }
    
    .form-control::-webkit-input-placeholder {
        color: #6c757d !important;
        opacity: 1;
    }
    
    .form-control::-moz-placeholder {
        color: #6c757d !important;
        opacity: 1;
    }
    
    .form-control:-ms-input-placeholder {
        color: #6c757d !important;
        opacity: 1;
    }
    
    /* Increase height of Country select field */
    select.form-control {
        height: calc(1.5em + 0.75rem + 4px) !important; /* Slightly taller than default */
        min-height: 42px !important;
        padding: 0.5rem 0.75rem !important;
    }

    /* Security indicators */
    .security-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        color: #155724;
        font-size: 0.875rem;
    }

    .security-badge i {
        margin-right: 4px;
    }

    /* Enhanced loading overlay */
    #loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(23, 162, 184, .9), rgba(13, 110, 253, .9));
        z-index: 9999;
        backdrop-filter: blur(2px);
    }

    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0;
        width: 100%;
        height: 100%;
        color: white;
        text-align: center;
    }

    .loading-spinner .spinner-text {
        margin-top: 20px;
        font-size: 1.2rem;
        font-weight: 300;
        text-align: center !important;
        width: 80%;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .loading-spinner .spinner-text #loading-message,
    .loading-spinner .spinner-text small {
        text-align: center !important;
        display: block;
        width: 100%;
    }

    /* Button states */
    .btn-black {
        background-color: #000;
        border-color: #000;
        color: #fff;
        transition: all 0.15s ease-in-out;
    }

    .btn-black:hover {
        background-color: #333;
        border-color: #333;
        color: #fff;
    }

    .btn-black:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        color: #fff;
        opacity: 0.65;
    }

    .btn-secondary:disabled {
        opacity: 0.65;
        cursor: not-allowed;
    }

    /* Form validation styles */
    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #dc3545;
    }

    .was-validated .form-control:invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .was-validated .form-control:valid {
        border-color: #28a745;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.94-.94 1.44 1.44L7.4 4.5l.94.94L4.66 9.17z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .stripe-style-input {
            font-size: 16px; /* Prevent zoom on iOS */
        }
        
        #loading-overlay .loading-spinner {
            padding: 20px;
        }
        
        .loading-spinner .spinner-text {
            font-size: 1rem;
            text-align: center !important;
        }

        .loading-spinner .spinner-text #loading-message,
        .loading-spinner .spinner-text small {
            text-align: center !important;
        }
    }

    /* Accessibility improvements */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Focus indicators for keyboard navigation */
    .btn:focus,
    .form-control:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }
</style>
{% endblock %}